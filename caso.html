<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalle del Caso | Soluciones Migratorias</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Header más grueso, logo más grande y fondo azul corporativo */
    header {
      background-color: #0a2a43;  /* azul corporativo */
      height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }
    header img { height: 100px; }

    /* Estado/alerta */
    #status.success {
      border:1px solid #b7e1cd; background:#f0fff4; color:#1e4620;
    }

    /* Helpers para tablas dinámicas */
    .kv-grid {
      display:grid;
      grid-template-columns: minmax(160px, 240px) 1fr;
      gap:10px 16px;
      align-items:start;
    }
    .kv-grid .k {font-weight:600; color:#0a2a43;}
    .kv-grid .v {color:#111;}
    .table-wrap {overflow:auto; border:1px solid var(--border,#e5e7eb); border-radius:8px;}
    table.dynamic {
      width:100%; border-collapse:collapse; min-width:640px; background:#fff;
    }
    table.dynamic th, table.dynamic td {
      border-bottom:1px solid var(--border,#e5e7eb);
      padding:10px; text-align:left; vertical-align:top;
    }
    table.dynamic th { background:#f6f8fb; font-weight:700; color:#0a2a43; position:sticky; top:0;}
    .muted {color:#666;}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <img src="logo2.png" alt="Soluciones Migratorias - Logo">
  </header>

  <!-- Barra informativa -->
  <section class="promo">
    Nuestra página principal |
    <a href="https://solucionesmigratorias.us" target="_blank" rel="noopener">solucionesmigratorias.us</a>
  </section>

  <!-- Contenido principal -->
  <main style="flex:1 0 auto; padding:20px;">
    <nav style="margin-bottom:20px; font-size:14px;">
      <a href="index.html">Inicio</a> > <span>Detalle del Caso</span>
    </nav>

    <h1 style="margin-bottom:20px; color:var(--brand-blue);">Detalle del Caso</h1>

    <!-- Área de estado/errores -->
    <div id="status" style="display:none; margin:10px 0; padding:10px; border-radius:8px;"></div>

    <!-- Tarjetas apiladas -->
    <section id="case-details" style="display:flex; flex-direction:column; gap:16px;">
      <div class="card">
        <h2>Información del Cliente</h2>
        <!-- ahora generamos un grid key:value con TODAS las columnas de la fila del caso -->
        <div id="cliente-grid" class="kv-grid"><p class="muted">Cargando…</p></div>
      </div>
      <div class="card">
        <h2>Fechas de Corte</h2>
        <!-- si no tienes columnas de corte, igualmente mostramos todo lo que traiga la fila -->
        <div id="corte-grid" class="kv-grid"><p class="muted">Cargando…</p></div>
      </div>
    </section>

    <!-- Actualizaciones -->
    <section class="card" style="margin-top:24px;">
      <h2>Actualizaciones del Caso</h2>
      <!-- aquí va una TABLA con todas las columnas de la hoja 'actualizaciones' -->
      <div id="updates-table" class="table-wrap"><p class="muted" style="padding:10px;">Cargando…</p></div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 | Soluciones Migratorias</p>
  </footer>

  <!-- Scripts -->
  <script>
    // ====== Utilidades UI ======
    const statusBox = document.getElementById('status');
    function showStatus(msg, type='error') {
      statusBox.classList.remove('success');
      statusBox.style.display = 'block';
      statusBox.innerHTML = msg;
      if (type === 'success') statusBox.classList.add('success');
    }

    // ====== Lectura y validación del código ======
    const params = new URLSearchParams(location.search);

    // Normaliza: mayúsculas, sin espacios ni símbolos
    const rawCodigo = params.get('codigo') || '';
    const codigo = rawCodigo.toUpperCase().replace(/[^A-Z0-9]/g,'').trim();

    // Regla: IOE + 10 dígitos (total 13)
    const CODE_RE = /^IOE\d{10}$/;

    // Prefijo para ruteo por hoja (si en el futuro separas por prefijos)
    const prefijo = 'IOE';

    // ====== Endpoints (cambia API_BASE si tu URL es otra) ======
    const API_BASE = "https://script.google.com/macros/s/AKfycbwQyE7b5JE0lXhx2RdvlHNYQnqvb8OpErxus6RaJe2UfCiIoxoO-8TF2d94Ts12cOTV/exec";
    const SHEET_URLS = { "IOE": `${API_BASE}?tab=casos` };
    const SHEET_UPDATES_URLS = { "IOE": `${API_BASE}?tab=actualizaciones` };

    // ====== Helpers de fecha ======
    function isDMYString(s){ return /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(String(s||'').trim()); }
    function toDateObj(value){
      if (!value) return new Date(0);
      const s = String(value).trim();
      if (isDMYString(s)) {
        const [d,m,y] = s.split('/').map(Number);
        return new Date(y,(m||1)-1,d||1);
      }
      const d = new Date(s);
      return isNaN(d.getTime()) ? new Date(0) : d;
    }
    function formatOnlyDate(value){
      if (!value) return '';
      if (isDMYString(value)) return String(value).trim();
      const d = toDateObj(value);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return (yyyy < 1971) ? '' : `${dd}/${mm}/${yyyy}`;
    }

    // ====== Helpers genéricos de render ======
    function titleCase(s){
      return String(s||'')
        .replace(/_/g,' ')
        .replace(/\b\w/g, ch => ch.toUpperCase());
    }

    async function fetchJSON(url){
      const res = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      return JSON.parse(text);
    }

    // Construye un grid key:value con TODAS las columnas de un objeto (una fila del sheet)
    function renderKVGrid(el, rowObj){
      if (!rowObj || typeof rowObj !== 'object') {
        el.innerHTML = '<p class="muted">No hay datos.</p>';
        return;
      }
      const keys = Object.keys(rowObj);
      if (!keys.length) {
        el.innerHTML = '<p class="muted">No hay datos.</p>';
        return;
      }
      el.innerHTML = keys.map(k => {
        let v = rowObj[k];
        // formatea campos llamados 'fecha' o que luzcan como fecha
        if (String(k).toLowerCase().includes('fecha')) {
          v = formatOnlyDate(v) || (v ?? '');
        }
        return `<div class="k">${titleCase(k)}</div><div class="v">${(v ?? '') === '' ? '<span class="muted">—</span>' : String(v)}</div>`;
      }).join('');
    }

    // Construye tabla con TODAS las columnas detectadas en la lista (array de objetos)
    function renderDynamicTable(el, rows){
      if (!Array.isArray(rows) || !rows.length) {
        el.innerHTML = '<p class="muted" style="padding:10px;">Sin actualizaciones.</p>';
        return;
      }
      // junta todas las keys que existan en cualquiera de las filas
      const keySet = new Set();
      rows.forEach(r => Object.keys(r||{}).forEach(k => keySet.add(k)));
      const keys = Array.from(keySet);

      // Orden sugerido: fecha, codigo, nombre primero si existen
      const prefer = ['fecha','codigo','nombre'];
      keys.sort((a,b)=>{
        const ia = prefer.indexOf(a.toLowerCase());
        const ib = prefer.indexOf(b.toLowerCase());
        if (ia !== -1 && ib !== -1) return ia - ib;
        if (ia !== -1) return -1;
        if (ib !== -1) return  1;
        return a.localeCompare(b);
      });

      // ordena por fecha desc si existe 'fecha'
      const hasFecha = keys.some(k => k.toLowerCase() === 'fecha');
      if (hasFecha){
        rows = rows.slice().sort((a,b)=> toDateObj(b.fecha) - toDateObj(a.fecha));
      }

      const thead = `<thead><tr>${keys.map(k=>`<th>${titleCase(k)}</th>`).join('')}</tr></thead>`;
      const tbody = `<tbody>${
        rows.map(r=>{
          return `<tr>${
            keys.map(k=>{
              let v = r?.[k] ?? '';
              if (String(k).toLowerCase().includes('fecha')) {
                v = formatOnlyDate(v) || (v ?? '');
              }
              return `<td>${(v === '') ? '<span class="muted">—</span>' : String(v)}</td>`;
            }).join('')
          }</tr>`;
        }).join('')
      }</tbody>`;

      el.innerHTML = `<div class="table-wrap-inner"><table class="dynamic">${thead}${tbody}</table></div>`;
    }

    // ====== Flujo principal ======
    async function cargarDatos(){
      // Validación de presencia
      if(!codigo){
        showStatus('Falta el parámetro <strong>codigo</strong> en la URL. Ejemplo: <code>caso.html?codigo=IOE0324567831</code>');
        document.getElementById('case-details').style.display = 'none';
        document.getElementById('updates-table').innerHTML = '';
        return;
      }

      // Validación de formato IOE + 10 dígitos
      if(!CODE_RE.test(codigo)){
        showStatus('El código no es válido. Debe tener el formato <strong>IOE</strong> seguido de <strong>10 dígitos</strong>. Ejemplo: <code>IOE0324567831</code>');
        document.getElementById('case-details').style.display = 'none';
        document.getElementById('updates-table').innerHTML = '';
        return;
      }

      const baseCasos   = SHEET_URLS[prefijo]         || `${API_BASE}?tab=casos`;
      const baseUpdates = SHEET_UPDATES_URLS[prefijo] || `${API_BASE}?tab=actualizaciones`;

      try{
        // 1) Caso (filtrado por código) —> usamos la PRIMERA fila
        const casos = await fetchJSON(baseCasos + "&codigo=" + encodeURIComponent(codigo));
        if(!casos || !casos.length){
          document.getElementById('cliente-grid').innerHTML = '<p class="muted">No se encontró el caso para este código.</p>';
          document.getElementById('corte-grid').innerHTML = '';
          document.getElementById('updates-table').innerHTML = '';
          return;
        }
        const caso = casos[0];

        // Pintar TODAS las columnas en ambos bloques (si no tienes “corte”, igual se muestran los campos disponibles)
        renderKVGrid(document.getElementById('cliente-grid'), caso);
        renderKVGrid(document.getElementById('corte-grid'), caso);

        // 2) Actualizaciones (todas las columnas que existan)
        const updates = await fetchJSON(baseUpdates + "&codigo=" + encodeURIComponent(caso.codigo || codigo));
        renderDynamicTable(document.getElementById('updates-table'), updates || []);

        showStatus('Código válido. Información cargada correctamente.', 'success');
      }catch(err){
        console.error(err);
        showStatus('Error al conectar con la hoja. Revisa la consola.', 'error');
        document.getElementById('cliente-grid').innerHTML = '';
        document.getElementById('corte-grid').innerHTML = '';
        document.getElementById('updates-table').innerHTML = '';
      }
    }

    cargarDatos();
  </script>
</body>
</html>
