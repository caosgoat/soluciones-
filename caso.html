<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalle del Caso | Soluciones Migratorias</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Header más grueso, logo más grande y fondo azul corporativo */
    header {
      background-color: #0a2a43;  /* azul corporativo */
      height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }
    header img { height: 100px; }
    /* Estado/alerta */
    #status.success {
      border:1px solid #b7e1cd; background:#f0fff4; color:#1e4620;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <img src="logo2.png" alt="Soluciones Migratorias - Logo">
  </header>

  <!-- Barra informativa -->
  <section class="promo">
    Nuestra página principal |
    <a href="https://solucionesmigratorias.us" target="_blank" rel="noopener">solucionesmigratorias.us</a>
  </section>

  <!-- Contenido principal -->
  <main style="flex:1 0 auto; padding:20px;">
    <nav style="margin-bottom:20px; font-size:14px;">
      <a href="index.html">Inicio</a> > <span>Detalle del Caso</span>
    </nav>

    <h1 style="margin-bottom:20px; color:var(--brand-blue);">Detalle del Caso</h1>

    <!-- Área de estado/errores -->
    <div id="status" style="display:none; margin:10px 0; padding:10px; border-radius:8px;"></div>

    <!-- Tarjetas apiladas -->
    <section id="case-details" style="display:flex; flex-direction:column; gap:16px;">
      <div class="card">
        <h2>Información del Cliente</h2>
        <div id="cliente-info"><p>Cargando…</p></div>
      </div>
      <div class="card">
        <h2>Fechas de Corte</h2>
        <div id="corte-info"><p>Cargando…</p></div>
      </div>
    </section>

    <!-- Actualizaciones -->
    <section class="card" style="margin-top:24px;">
      <h2>Actualizaciones del Caso</h2>
      <div id="updates-list"><p>Cargando…</p></div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 | Soluciones Migratorias</p>
  </footer>

  <!-- Scripts (solo este bloque fue modificado) -->
  <script>
    // ====== Utilidades UI ======
    const statusBox = document.getElementById('status');
    function showStatus(msg, type='error') {
      statusBox.classList.remove('success');
      statusBox.style.display = 'block';
      statusBox.innerHTML = msg;
      if (type === 'success') statusBox.classList.add('success');
    }

    // ====== Lectura y validación del código ======
    const params = new URLSearchParams(location.search);
    const rawCodigo = params.get('codigo') || '';
    const codigo = rawCodigo.toUpperCase().replace(/[^A-Z0-9]/g,'').trim();

    // CAMBIO 1: Regex tolerante (IOE opcional + 10 dígitos)
    const CODE_RE = /^(?:IOE)?\d{10}$/;
    const prefijo = 'IOE';

    // ====== ENDPOINT: tu URL /exec actual ======
    const API_BASE = "https://script.google.com/macros/s/AKfycbxp0DwJl1haPzWqJ-Kre_8XfEETJfYDoeH13IICxw4eTqYBGplIkDHtPqHjhfwtQHiC/exec";

    const SHEET_URLS = { "IOE": `${API_BASE}?tab=casos` };
    const SHEET_UPDATES_URLS = { "IOE": `${API_BASE}?tab=actualizaciones` };

    // ====== Helpers de fecha ======
    function isDMYString(s){ return /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(String(s||'').trim()); }
    function toDateObj(value){
      if (!value) return new Date(0);
      const s = String(value).trim();
      if (isDMYString(s)) {
        const [d,m,y] = s.split('/').map(Number);
        return new Date(y,(m||1)-1,d||1);
      }
      const d = new Date(s);
      return isNaN(d.getTime()) ? new Date(0) : d;
    }
    function formatOnlyDate(value){
      if (!value) return '';
      if (isDMYString(value)) return String(value).trim();
      const d = toDateObj(value);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // CAMBIO 2: Fetch robusto con anti-caché + debug visible
    async function fetchJSON(url){
      try{
        const full = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
        console.log('[FETCH] ->', full);
        if (statusBox) {
          statusBox.style.display = 'block';
          statusBox.classList.add('success');
          statusBox.innerHTML = `Consultando:<br><code style="font-size:12px">${full}</code>`;
        }

        const res = await fetch(full, {
          method:'GET',
          headers: { 'Accept':'application/json' },
          cache: 'no-store'
        });
        const text = await res.text();
        console.log('[FETCH][status]', res.status, res.statusText);

        if (!res.ok) {
          console.error('[FETCH][body]', text);
          (document.getElementById('updates-list')||document.body).innerHTML =
            `<pre style="white-space:pre-wrap;background:#fff;border:1px solid #ddd;padding:8px">HTTP ${res.status}\n${text.slice(0,1000)}</pre>`;
          throw new Error(`HTTP ${res.status}`);
        }
        try {
          return JSON.parse(text);
        } catch(parseErr) {
          console.error('[FETCH][parse error] body:', text);
          (document.getElementById('updates-list')||document.body).innerHTML =
            `<pre style="white-space:pre-wrap;background:#fff;border:1px solid #ddd;padding:8px">Respuesta no JSON:\n${text.slice(0,1000)}</pre>`;
          throw parseErr;
        }
      }catch(err){
        console.error('fetchJSON error:', err);
        if (statusBox && statusBox.style.display !== 'block') {
          statusBox.style.display = 'block';
          statusBox.innerHTML = `❌ Error conectando con la API: <code>${String(err.message || err)}</code>`;
        }
        throw err;
      }
    }

    function renderCliente(row){
      document.getElementById('cliente-info').innerHTML = `
        <p><strong>Nombre:</strong> ${row.nombre || '-'}</p>
        <p><strong>Documento:</strong> ${row.documento || '-'}</p>
        <p><strong>Código:</strong> ${row.codigo || '-'}</p>
        <p><strong>Dirección:</strong> ${row.direccion || '-'}</p>
        <p><strong>Tipo de Caso:</strong> ${row.tipoCaso || '-'}</p>
        <p><strong>Abogado Asignado:</strong> ${row.abogadoAsignado || '-'}</p>
      `;
      document.getElementById('corte-info').innerHTML = `
        <p><strong>Fecha de Corte:</strong> ${row.fechaCorte ? formatOnlyDate(row.fechaCorte) : '-'}</p>
        <p><strong>Tipo de Corte:</strong> ${row.tipoCorte || '-'}</p>
        <p><strong>Estado de Pago:</strong> ${row.estadoPago || '-'}</p>
      `;
    }

    function renderUpdates(list){
      const cont = document.getElementById('updates-list');
      if(!Array.isArray(list) || !list.length){
        cont.innerHTML = '<p>No hay actualizaciones registradas.</p>';
        return;
      }
      list.sort((a,b)=> toDateObj(b.fecha) - toDateObj(a.fecha));
      cont.innerHTML = list.map(u => `
        <div class="update-item" style="display:flex; gap:12px; align-items:flex-start; margin:10px 0;">
          <div class="update-date-box" style="
            min-width:90px; text-align:center; background:#f6f8fb; color:#111;
            border:1px solid var(--border); border-radius:8px; padding:8px 10px; font-weight:700;">
            ${formatOnlyDate(u.fecha) || '-'}
          </div>
          <details class="update-details" style="flex:1; background:#fff; border:1px solid var(--border); border-radius:8px; padding:10px 12px;">
            <summary style="cursor:pointer; font-weight:700; color:var(--brand-blue); outline:none;">
              Ver actualización
            </summary>
            <div style="margin-top:8px; color:#333; line-height:1.6;">
              ${u.nota ?? u.detalle ?? u.descripcion ?? '<em>Sin detalle</em>'}
            </div>
          </details>
        </div>
      `).join('');
    }

    async function cargarDatos(){
      // Validaciones de URL
      if(!codigo){
        showStatus('Falta el parámetro <strong>codigo</strong> en la URL. Ejemplo: <code>caso.html?codigo=IOE0324567831</code>');
        document.getElementById('case-details').style.display = 'none';
        document.getElementById('updates-list').innerHTML = '';
        return;
      }
      if(!CODE_RE.test(codigo)){
        showStatus('El código no es válido. Debe tener el formato <strong>IOE</strong> (opcional) seguido de <strong>10 dígitos</strong>. Ej.: <code>IOE0324567831</code> o <code>0324567831</code>');
        document.getElementById('case-details').style.display = 'none';
        document.getElementById('updates-list').innerHTML = '';
        return;
      }

      const baseCasos   = SHEET_URLS[prefijo]         || `${API_BASE}?tab=casos`;
      const baseUpdates = SHEET_UPDATES_URLS[prefijo] || `${API_BASE}?tab=actualizaciones`;

      try{
        // CASO
        const urlCaso = `${baseCasos}&codigo=${encodeURIComponent(codigo)}`;
        const casos = await fetchJSON(urlCaso);
        const rowsCasos = Array.isArray(casos) ? casos : (casos && casos.rows) ? casos.rows : [];
        if(!rowsCasos.length){
          document.getElementById('cliente-info').innerHTML = '<p>No se encontró el caso para este código.</p>';
          document.getElementById('corte-info').innerHTML = '';
          document.getElementById('updates-list').innerHTML = '';
          return;
        }
        renderCliente(rowsCasos[0]);

        // ACTUALIZACIONES
        const urlUpdates = `${baseUpdates}&codigo=${encodeURIComponent(codigo)}`;
        const updates = await fetchJSON(urlUpdates);
        const rowsUpdates = Array.isArray(updates) ? updates : (updates && updates.rows) ? updates.rows : [];
        renderUpdates(rowsUpdates);
        showStatus('Código válido. Información cargada correctamente.', 'success');
      }catch(err){
        console.error('cargarDatos error:', err);
        document.getElementById('cliente-info').innerHTML = '<p>Error al conectar con la hoja.</p>';
        document.getElementById('corte-info').innerHTML = '';
        document.getElementById('updates-list').innerHTML = '';
      }
    }

    document.addEventListener('DOMContentLoaded', cargarDatos);
  </script>
</body>
</html>
